<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>七牛</title>
</head>

<body>
    <iframe name='iframeName'></iframe>

    <form action='https://upload-z2.qiniup.com' target='iframeName' method='post' enctype="multipart/form-data">
        <input name="token" value="">
        <input type='file' />
        
        <button type='submit'>开始上传</button>
    </form>

    <script src='https://cdn.bootcss.com/jquery/2.2.2/jquery.min.js'></script>
    <script src='https://cdn.bootcss.com/axios/0.18.0/axios.min.js'></script>
    <script>

        var formData=new FormData()
        var domain=''
        $.post('https://mao.kuaiyunma.com/up_token')
        .then(function(res){
            domain=res.data.domain
            formData.append('token',res.data.upToken)

            $('[name="token"]').val( res.data.upToken )
        })

        $('form').submit(function (e){
            e.preventDefault()

            var files=$('input[type="file"]').prop('files')
            if( files.length==0 ){
                alert('请选择文件')
                return
            }

            formData.append('file',files[0])

            axios({
                method : 'post',
                url : 'http://upload-z2.qiniup.com',
                headers: {"Content-Type": "multipart/form-data"},
                data : formData,
                onUploadProgress : function (status){
                    var progress=parseFloat(status.loaded / status.total * 100)
                    if(progress>95){
                        progress=95
                    }

                    $('button').html('正在上传'+progress.toFixed(2)+'%')
                }
            })
            .then((res)=>{
                if(res.status==200){
                    $('iframe').prop('src',domain+'/'+res.data.hash)
                }
            })
            .catch(console.log)

        })

        // http://po8qk0gp0.bkt.clouddn.com/lnzwmYerik3NYzG3TpNtefBre6_g

    </script>
</body>
</html>
